# 단위 테스트 (Unit Tests) - `unit.md`

이 문서는 `tests/unit/` 디렉토리에 있는 단위 테스트의 목적과 구현 방식에 대해 상세히 설명합니다.

## 1. 단위 테스트의 목적

단위 테스트의 핵심 목적은 **각 소프트웨어 구성 요소(모듈, 클래스, 함수)를 개별적으로, 그리고 외부 환경으로부터 완전히 고립된 상태에서 검증**하는 것입니다. 이를 통해 다음과 같은 이점을 얻습니다.

-   **빠른 피드백**: 단위 테스트는 매우 빨라 코드 변경 시 즉각적인 결과를 확인할 수 있습니다.
-   **정확한 오류 위치 파악**: 테스트가 실패하면 문제의 원인이 해당 단위에 국한되므로 디버깅이 용이합니다.
-   **안전한 리팩토링**: 내부 구현을 변경하더라도, 단위 테스트가 통과한다면 기존 기능이 유지된다는 확신을 가질 수 있습니다.

이를 위해 단위 테스트에서는 **모킹(Mocking)** 기법을 적극적으로 사용합니다. 모킹은 테스트 대상이 의존하는 다른 컴포넌트나 외부 시스템(네트워크, 데이터베이스 등)을 '가짜 객체(Mock)'로 대체하는 기술입니다.

## 2. 모듈별 단위 테스트 설명

### `test_cache.py`

-   **목적**: `src/producer/cache.py`의 SQLite 데이터베이스 상호작용 로직을 검증합니다.
-   **핵심 기술**:
    -   `pytest`의 `tmp_path` Fixture를 사용하여 테스트마다 임시 DB 파일을 생성합니다.
    -   `monkeypatch` Fixture를 사용하여 `cache.DATABASE_PATH` 변수를 이 임시 DB 파일 경로로 동적으로 변경합니다.
-   **검증 내용**:
    -   DB 테이블이 올바르게 생성되는지 (`test_setup_database`)
    -   데이터 저장 후 조회가 정확한지 (`test_save_and_get_qids`)
    -   존재하지 않는 데이터 조회 시 올바르게 처리하는지 (`test_get_non_existent_qids`)

### `test_collector.py`

-   **목적**: `src/producer/collector.py`의 실시간 이벤트 수집 및 마이크로 배치 로직을 검증합니다.
-   **핵심 기술**:
    -   `mocker.patch`를 사용하여 `httpx`와 `httpx_sse`를 모킹함으로써 실제 네트워크 연결을 차단합니다.
    -   `@pytest.mark.parametrize`를 사용하여 '배치 크기 도달', '타임아웃', 'JSON 오류', '네트워크 재연결' 등 여러 시나리오를 단일 테스트 함수로 검증합니다.
-   **검증 내용**:
    -   다양한 조건에서 이벤트가 올바르게 수집되고 콜백 함수로 전달되는지 확인합니다.

### `test_enricher.py`

-   **목적**: `src/producer/enricher.py`의 데이터 보강 로직을 검증합니다.
-   **핵심 기술**:
    -   `cache.py`의 함수들과 `httpx.Client.get`을 모킹하여 DB와 외부 API를 차단합니다.
    -   `@pytest.mark.parametrize`를 사용하여 '캐시 히트', 'API 호출', 'API 에러', '다양한 API 응답 엣지 케이스' 등의 시나리오를 검증합니다.
-   **검증 내용**:
    -   Q-ID 추출, 캐시 조회, API 호출, 데이터 보강의 흐름이 시나리오에 따라 정확히 동작하는지 확인합니다.

### `test_sender.py`

-   **목적**: `src/producer/sender.py`의 Kafka 메시지 전송 로직을 검증합니다.
-   **핵심 기술**:
    -   `mocker.patch`를 사용하여 `KafkaProducer` 클래스 자체를 모킹함으로써 실제 Kafka 브로커와의 연결을 차단합니다.
-   **검증 내용**:
    -   `KafkaProducer`가 올바른 설정으로 초기화되는지 확인합니다.
    -   `send_events` 메서드가 각 이벤트를 `producer.send`로 전달하고 `flush`를 호출하는지 확인합니다.

### `test_main.py`

-   **목적**: `src/producer/main.py`가 각 모듈을 올바르게 조립하고 파이프라인을 구성하는지 검증합니다.
-   **핵심 기술**:
    -   `Collector`, `Enricher`, `Sender` 클래스들을 모두 모킹합니다.
-   **검증 내용**:
    -   `run_producer` 함수가 각 모듈을 올바른 설정값으로 초기화하는지 확인합니다.
    -   `Collector`의 콜백 함수가 설정되고, `run()` 메서드가 최종적으로 호출되는지 확인합니다.
